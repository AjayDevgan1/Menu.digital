<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Owner Dashboard ‚Äì Wooden Garden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #5d4037;
      --accent: #8bc34a;
      --bg: #fff8e1;
      --light: #ffffff;
      --border: #ddd;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
      background: var(--bg);
      color: var(--primary);
    }

    h1 {
      margin-bottom: 15px;
      font-weight: 700;
    }

    button#logout {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 25px;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    button#logout:hover {
      background: #4e342e;
    }

    .section {
      background: var(--light);
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
    }

    .section-header {
      background: var(--primary);
      color: white;
      padding: 14px 20px;
      cursor: pointer;
      font-size: 1.15rem;
      font-weight: 600;
      user-select: none;
    }

    .section-header:hover {
      background: #4e342e;
    }

    .section-content {
      padding: 15px 20px;
      display: none;
      color: #3e2723;
    }

    .section.active .section-content {
      display: block;
    }

    #sales-summary {
      font-weight: 700;
      font-size: 1.25rem;
      margin-top: 10px;
    }

    .order, .menu-item, .menu-edit-form {
      background: #fafafa;
      margin: 12px 0;
      padding: 14px 15px;
      border-left: 5px solid var(--primary);
      border-radius: 5px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.07);
    }

    input, select, button {
      margin: 6px 0;
      padding: 8px 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover {
      background: #4e342e;
    }

    .menu-item > div {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .menu-item > div > input {
      flex: 1;
      min-width: 130px;
    }

    .save-btn, .delete-btn {
      padding: 8px 14px;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .delete-btn {
      background: #e53935;
      color: white;
    }
    .delete-btn:hover {
      background: #ab2a27;
    }

    @media (max-width: 600px) {
      .menu-item > div {
        flex-direction: column;
        align-items: stretch;
      }
      button.save-btn, button.delete-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>üë®‚Äçüíº Owner Panel</h1>
  <button id="logout">Logout</button>

  <div class="section" id="section-sales">
    <div class="section-header">üìà Today's Sales</div>
    <div class="section-content">
      <div id="sales-summary">Loading...</div>
    </div>
  </div>

  <div class="section" id="section-orders">
    <div class="section-header">üßæ Order History</div>
    <div class="section-content">
      <div id="orders"></div>
    </div>
  </div>

  <div class="section" id="section-menu">
    <div class="section-header">üçΩÔ∏è Manage Menu Items</div>
    <div class="section-content">
      <form id="add-menu-form" class="menu-edit-form" autocomplete="off">
        <input type="text" id="new-name" placeholder="Item Name" required />
        <input type="number" id="new-price" placeholder="Price (Rs.)" required min="0" />
        <input type="text" id="new-category" placeholder="Category" required />
        <button type="submit">Add Item</button>
      </form>

      <div id="menu"></div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    const auth = getAuth();
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html"; // force login
      }
    });

    document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      });
    });

    const ordersRef = ref(db, 'orders');
    const menuRef = ref(db, 'menu');
    const ordersDiv = document.getElementById('orders');
    const menuDiv = document.getElementById('menu');
    const salesDiv = document.getElementById('sales-summary');

    // Show order history + today's sales
    onValue(ordersRef, (snapshot) => {
      const data = snapshot.val() || {};
      let totalSales = 0;
      const today = new Date().toDateString();

      ordersDiv.innerHTML = '';
      for (let id in data) {
        const order = data[id];
        const date = new Date(order.timestamp);
        const isToday = date.toDateString() === today;

        const div = document.createElement('div');
        div.className = 'order';
        div.innerHTML = `
          <strong>${order.name}</strong><br>
          Rs. ${order.price}<br>
          <small>${date.toLocaleString()}</small>
        `;
        ordersDiv.prepend(div);

        if (isToday) totalSales += Number(order.price);
      }
      salesDiv.innerText = `Rs. ${totalSales} (from today's orders)`;
    });

    // Render menu items with edit/delete options
    onValue(menuRef, (snapshot) => {
      const data = snapshot.val() || {};
      menuDiv.innerHTML = '';
      for (let id in data) {
        const item = data[id];

        const div = document.createElement('div');
        div.className = 'menu-item';

        div.innerHTML = `
          <div>
            <input type="text" value="${item.name}" data-id="${id}" data-field="name" />
            <input type="number" value="${item.price}" data-id="${id}" data-field="price" min="0" />
            <input type="text" value="${item.category}" data-id="${id}" data-field="category" />
            <button data-id="${id}" class="save-btn">Save</button>
            <button data-id="${id}" class="delete-btn">Delete</button>
          </div>
        `;

        menuDiv.appendChild(div);
      }

      // Attach event listeners after rendering
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const name = document.querySelector(`input[data-id="${id}"][data-field="name"]`).value.trim();
          const price = parseFloat(document.querySelector(`input[data-id="${id}"][data-field="price"]`).value);
          const category = document.querySelector(`input[data-id="${id}"][data-field="category"]`).value.trim();

          if (!name || isNaN(price) || !category) {
            alert("Please fill all fields correctly.");
            return;
          }

          update(ref(db, `menu/${id}`), { name, price, category })
            .then(() => alert("Updated successfully"))
            .catch(e => alert("Update failed: " + e.message));
        };
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          if (confirm("Are you sure you want to delete this item?")) {
            remove(ref(db, `menu/${id}`))
              .catch(e => alert("Delete failed: " + e.message));
          }
        };
      });
    });

    // Handle add new item form submit
    document.getElementById('add-menu-form').onsubmit = (e) => {
      e.preventDefault();

      const nameInput = document.getElementById('new-name');
      const priceInput = document.getElementById('new-price');
      const categoryInput = document.getElementById('new-category');

      const name = nameInput.value.trim();
      const price = parseFloat(priceInput.value);
      const category = categoryInput.value.trim();

      if (!name || isNaN(price) || !category) {
        alert("Please fill all fields correctly.");
        return;
      }

      push(menuRef, { name, price, category })
        .then(() => {
          alert("Added new menu item!");
          nameInput.value = '';
          priceInput.value = '';
          categoryInput.value = '';
        })
        .catch(e => alert("Failed to add: " + e.message));
    };

    // Section toggle (accordion) logic after DOM ready
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.section-header').forEach(header => {
        header.addEventListener('click', () => {
          const section = header.parentElement;
          section.classList.toggle('active');
        });
      });

      // Open Today's Sales by default
      document.getElementById('section-sales')?.classList.add('active');
    });
  </script>
</body>
</html>
